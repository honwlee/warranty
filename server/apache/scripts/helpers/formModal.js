/**
 * warranty - 
 * @author 
 * @version v0.0.0
 * @link 
 * @license 
 */
define(["jquery","server","skylarkjs","./Partial","./itemActions","toastr","text!./_partials.hbs","handlebars"],function(r,e,t,a,n,i,o,s){function l(e,t,a,n){var o="create",s={},l=new FormData;if(t.find("input").each(function(){if("file"!=this.type){var e=r(this);l.append(e.attr("name"),e.val()),s[e.attr("name")]=e.val()}}),s.id&&(o="update"),a.file){l.append("thumbnail",a.file);var c=a.file.name,f=c.split(".")[1];if(!/(gif|jpg|jpeg|png)$/i.test(f))return i.error("缩略图格式只支持gif、jpg或者png！")}delete a.file;for(var d in a)l.append(d,a[d]);var u="/api/"+e+"/"+o,m=new XMLHttpRequest;m.open("POST",u,!0),m.onreadystatechange=function(){if(4===m.readyState)if(200===m.status){var r=JSON.parse(m.response||m.responseText);r.status?n(r.result):r.auth?(i.error("未登录或者session失效，请登录后再操作！"),window.go("/sigin")):r.validate?i.error("数据已存在：("+r.key+":"+r.value+")"):i.error("系统错误，请截图并联系管理员，谢谢合作！")}else i.error("系统错误，请请截图并联系管理员，谢谢合作！")},m.send(l)}var c=(t.langx,{warrantyID:{emptyMsg:"质保ID不能为空",numsMsg:"用户名不能少于6位",numlMsg:"用户名不能多于14位",snMsg:"用户名必须以字母开头",validateMsg:"用户名不能包含字符",check:function(e){var t=r("#warrantyID");return t.val()?{error:!1}:(t.focus(),{error:!0,msg:this.emptyMsg})}},productRoll:{emptyMsg:"产品卷号不能为空",check:function(e){var t=r("#productRoll");return t.val()?{error:!1}:(t.focus(),{error:!0,msg:this.emptyMsg})}},licensePlate:{emptyMsg:"车牌号/车架号不能为空",check:function(e){var t=r("#licensePlate");return t.val()?{error:!1}:(t.focus(),{error:!0,msg:this.emptyMsg})}},company:{emptyMsg:"公司名称不能为空",check:function(e){var t=r("#company");return t.val()?{error:!1}:(t.focus(),{error:!0,msg:this.emptyMsg})}}});return{files:{},_formatPData:function(r){return n.formatPData(r)},_formatWData:function(r){return n.formatWData(r)},show:function(e,t,a,n){var i=this.modal=r("#formModal");return this["show_"+e](t,a,n),i.modal("show"),i.off("keypress").on("keypress",function(r){13===r.keyCode&&i.find(".save-btn").click()}),i},show_product:function(r,e){r=this._formatPData(r);var t=this,n=this.modal,o=r.id?"编辑产品":"添加产品";a.get("product-form-partial");var f=s.compile("{{> product-form-partial}}");n.find(".modal-body").html(f(r)),n.find(".modal-title").html(o),n.find(".save-btn").off("click").on("click",function(){var a=c.productRoll.check();!r.productRoll&&a.error?i.error(a.msg):l("products",n,{file:t.files.product},function(r){t.files.product=null,i.success("已保存！"),e(r),n.modal("hide")})}),n.find("#prodForm input.thumbnail").on("change",function(r){t.files.product=this.files[0]})},show_warranty:function(r,e){r=this._formatWData(r);var t=this,n=this.modal,o=r.id?"编辑质保":"添加质保";a.get("warranty-form-partial");var f=s.compile("{{> warranty-form-partial}}");n.find(".modal-body").html(f(r)),n.find(".modal-title").html(o),n.find(".save-btn").off("click").on("click",function(){var a=c.warrantyID.check();if(!r.warrantyID&&a.error)i.error(a.msg);else{var a=c.licensePlate.check();a.error?i.error(a.msg):l("warranties",n,{file:t.files.warranty},function(r){i.success("已保存！"),t.files.warranty=null,e(r),n.modal("hide")})}}),n.find("#wForm input.thumbnail").on("change",function(r){t.files.warranty=this.files[0]})},show_dealer:function(r,t,n){var o=this.modal,f=r.id?"编辑经销商":"添加经销商";e().getProvinces().then(function(n){a.get("dealer-form-partial");var d=s.compile("{{> dealer-form-partial}}");o.find(".modal-body").html(d({provinces:n,dealer:r}));var u=o.find("#fCityS"),m=o.find("#fProvinceS");o.find("#fProvinceS").on("change",function(){this.value||i.warning("请选择省份！"),e().getCities(this.value,u)}),r.id&&(m.val(r.provinceId),m.off("change").on("change",function(){e().getCities(this.value,u).then(function(){u.val(r.cityId)})}),m.change()),o.find(".modal-title").html(f),o.find(".save-btn").off("click").on("click",function(){var e=c.company.check();!r.company&&e.error?i.error(e.msg):l("dealers",o,{provinceId:m.val(),cityId:u.val()},function(r){i.success("已保存！"),t(r),o.modal("hide")})})})}}});