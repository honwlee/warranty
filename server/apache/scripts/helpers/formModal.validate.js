/**
 * warranty - 
 * @author 
 * @version v0.0.0
 * @link 
 * @license 
 */
define(["jquery","server","skylarkjs","./validates","./Partial","./itemActions","toastr","text!./_partials.hbs","handlebars"],function(e,i,r,a,t,n,o,l,s){function f(i,r,t,n){var l="create",s={},d=new FormData;if(r.find("input").each(function(){if("file"!=this.type){var i=e(this);d.append(i.attr("name"),i.val()),s[i.attr("name")]=i.val()}}),s.id&&(l="update"),t.file){d.append("thumbnail",t.file);var c=t.file.name,u=c.split(".")[1];if(!/(gif|jpg|jpeg|png)$/i.test(u))return o.error("缩略图格式只支持gif、jpg或者png！")}delete t.file;for(var h in t)d.append(h,t[h]);var m="/api/"+i+"/"+l,p=new XMLHttpRequest;p.open("POST",m,!0),p.onreadystatechange=function(){if(4===p.readyState)if(200===p.status){var e=JSON.parse(p.response||p.responseText);e.status?n(e.result):e.auth?(o.error("未登录或者session失效，请登录后再操作！"),window.go("/sigin")):e.validate?(o.error("数据已存在：("+a[e.key].nameMsg+":"+e.value+")"),r.find(".override-btn").removeClass("hide").off("click").on("click",function(){t.override=!0,f(i,r,t,n)})):o.error("系统错误，请截图并联系管理员，谢谢合作！")}else o.error("系统错误，请请截图并联系管理员，谢谢合作！")},p.send(d)}r.langx;return{files:{},_formatPData:function(e){return n.formatPData(e)},_formatWData:function(e){return n.formatWData(e)},show:function(i,r,a,t){var n=this.modal=e("#formModal");return this["show_"+i](r,a,t),n.find(".override-btn").addClass("hide"),n.modal("show"),n.off("keypress").on("keypress",function(e){13===e.keyCode&&n.find(".save-btn").click()}),n},show_product:function(e,i){e=this._formatPData(e);var r=this,n=this.modal,l=e.id?"编辑产品":"添加产品";t.get("product-form-partial");var d=s.compile("{{> product-form-partial}}");n.find(".modal-body").html(d(e)),n.find(".modal-title").html(l),n.find(".override-btn").addClass("hide"),n.find(".save-btn").off("click").on("click",function(){var e=a.productRoll.check();e.error?o.error(e.msg):f("products",n,{file:r.files.product},function(e){r.files.product=null,o.success("已保存！"),i(e),n.modal("hide")})}),n.find("#prodForm input.thumbnail").on("change",function(e){r.files.product=this.files[0]})},show_warranty:function(e,i){e=this._formatWData(e);var r=this,n=this.modal,l=e.id?"编辑质保":"添加质保";t.get("warranty-form-partial");var d=s.compile("{{> warranty-form-partial}}");n.find(".override-btn").addClass("hide"),n.find(".modal-body").html(d(e)),n.find(".modal-title").html(l),n.find(".save-btn").off("click").on("click",function(){var e=a.warrantyID.check();if(e.error)o.error(e.msg);else{var e=a.licensePlate.check();e.error?o.error(e.msg):f("warranties",n,{file:r.files.warranty},function(e){o.success("已保存！"),r.files.warranty=null,i(e),n.modal("hide")})}}),n.find("#wForm input.thumbnail").on("change",function(e){r.files.warranty=this.files[0]})},show_dealer:function(e,r,n){var l=this.modal,d=e.id?"编辑经销商":"添加经销商";i().getProvinces().then(function(n){t.get("dealer-form-partial");var c=s.compile("{{> dealer-form-partial}}");l.find(".modal-body").html(c({provinces:n,dealer:e}));var u=l.find("#fCityS"),h=l.find("#fProvinceS");l.find("#fProvinceS").on("change",function(){this.value||o.warning("请选择省份！"),i().getCities(this.value,u)}),e.id&&(h.val(e.provinceId),h.off("change").on("change",function(){i().getCities(this.value,u).then(function(){u.val(e.cityId)})}),h.change()),l.find(".override-btn").addClass("hide"),l.find(".modal-title").html(d),l.find(".save-btn").off("click").on("click",function(){var e=a.company.check();e.error?o.error(e.msg):f("dealers",l,{provinceId:h.val(),cityId:u.val()},function(e){o.success("已保存！"),r(e),l.modal("hide")})})})}}});